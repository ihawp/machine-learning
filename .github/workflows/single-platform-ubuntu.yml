name: Multi-Platform Vcpkg Manifest Build

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    # --- Use the correct marketplace action for vcpkg setup and manifest install ---
    - name: Setup Vcpkg and Install Dependencies
      uses: lukka/run-vcpkg@v11
      with:
        # Automatically detects vcpkg.json and runs 'vcpkg install'
        runVcpkgInstall: true 
        # Caches the vcpkg executable and built packages
        vcpkgDirectory: '${{ runner.temp }}/vcpkg'
        vcpkgRootPath: '${{ runner.temp }}/vcpkg'


    - name: Configure CMake
      # We explicitly pass the CMAKE_TOOLCHAIN_FILE using the output variable
      # generated by the 'runvcpkg' step (via steps.runvcpkg.outputs.vcpkgRootPath)
      run: |
        # Use an intermediate shell variable to build the command string
        CMAKE_CMD="cmake -B build -S . -DCMAKE_TOOLCHAIN_FILE=${{ steps.runvcpkg.outputs.vcpkgRootPath }}/scripts/buildsystems/vcpkg.cmake"
        
        # Add build type flag for non-Windows platforms
        if [ "${{ matrix.os }}" != "windows-latest" ]; then
          CMAKE_CMD="$CMAKE_CMD -DCMAKE_BUILD_TYPE=Release"
        fi
        
        echo "Running command: $CMAKE_CMD"
        eval $CMAKE_CMD

    - name: Build Project
      run: cmake --build build --config Release

    # Optional: Run Tests
    # - name: Test Project
    #   working-directory: ${{ github.workspace }}/build
    #   run: ctest --build-config Release
