name: Multi-Platform Vcpkg Manifest Build

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    # This action sets up vcpkg, installs dependencies via vcpkg.json, 
    # and sets the VCPKG_ROOT environment variable for subsequent commands.
    - name: Setup Vcpkg and Install Dependencies
      uses: lukka/run-vcpkg@v11
      with:
        runVcpkgInstall: true 
        vcpkgDirectory: '${{ runner.temp }}/vcpkg'

    # Combine configure and build into one step to ensure environment consistency
    - name: Configure and Build Project
      shell: pwsh
      run: |
        $TOOLCHAIN_FILE = "$env:VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake"
        $CMAKE_CMD = "cmake -B build -S . -DCMAKE_TOOLCHAIN_FILE=$TOOLCHAIN_FILE"
        
        if ($env:RUNNER_OS -ne "Windows") {
          $CMAKE_CMD += " -DCMAKE_BUILD_TYPE=Release"
        }
        
        Write-Output "Running configuration command: $CMAKE_CMD"
        & cmake @($CMAKE_CMD.Split(' '))
        
        Write-Output "Starting build..."
        cmake --build build --config Release

