name: Multi-Platform Vcpkg Manifest Build

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    # This action sets up vcpkg, installs dependencies via vcpkg.json, 
    # and sets the VCPKG_ROOT environment variable for subsequent commands.
    - name: Setup Vcpkg and Install Dependencies
      uses: lukka/run-vcpkg@v11
      with:
        runVcpkgInstall: true 
        vcpkgDirectory: '${{ runner.temp }}/vcpkg'

    # Combine configure and build into one step to ensure environment consistency
    - name: Configure and Build Project
      run: |
        # Use the VCPKG_ROOT environment variable set by the previous step
        TOOLCHAIN_FILE="$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake"
        
        # Build the configuration command dynamically
        CMAKE_CMD="cmake -B build -S . -DCMAKE_TOOLCHAIN_FILE=$TOOLCHAIN_FILE"

        # Add build type flag for non-Windows platforms
        if [ "${{ matrix.os }}" != "windows-latest" ]; then
          CMAKE_CMD="$CMAKE_CMD -DCMAKE_BUILD_TYPE=Release"
        fi
        
        echo "Running configuration command: $CMAKE_CMD"
        eval $CMAKE_CMD
        
        echo "Starting build..."
        cmake --build build --config Release
